# test04.ts コード構造分析

## 全体概要
総行数: 1095行

## ゲーム設定定数（7行～83行、合計77行）
ゲーム全体の設定を定義する定数オブジェクト

## ゲーム初期化処理（84行～99行、合計16行）
Gameインスタンスの作成と初期化設定

## GameOverSceneクラス（101行～188行、合計88行）
ゲームオーバー時の画面を管理するクラス

### コンストラクター（109行～164行、合計56行）
- 黒背景の作成（113行～116行、合計4行）
- Game Overテキストの作成（119行～130行、合計12行）
- スコアテキストの作成（133行～144行、合計12行）
- リトライテキストの作成（147行～159行、合計13行）
- イベントハンドラーの設定（162行～163行、合計2行）

### update関数（166行～174行、合計9行）
フレームカウントとリトライ可能状態の管理

### onCanvasClick関数（176行～181行、合計6行）
クリック時のシーン遷移処理

### destroy関数（183行～187行、合計5行）
イベントリスナーのクリーンアップ

## Blockクラス（190行～251行、合計62行）
移動するブロックを管理するクラス

### コンストラクター（198行～221行、合計24行）
ブロックの描画とプロパティ初期化

### update関数（223行～237行、合計15行）
ブロックの移動と画面外判定

### attachThread関数（239行～241行、合計3行）
糸のアタッチ処理

### getBounds関数（243行～250行、合計8行）
衝突判定用の境界情報を返す

## Threadクラス（253行～373行、合計121行）
プレイヤーが発射する糸を管理するクラス

### コンストラクター（270行～298行、合計29行）
糸の初期設定と方向の正規化

### update関数（300行～329行、合計30行）
糸の伸長とブロックへの追従処理

### checkCollision関数（331行～352行、合計22行）
ブロックとの衝突判定処理

### drawLine関数（354行～359行、合計6行）
糸の描画処理

### その他のヘルパー関数（361行～372行、合計12行）
- isAttachedToBlock（361行～363行、合計3行）
- getEndPosition（365行～367行、合計3行）
- updateStartPosition（369行～372行、合計4行）

## Particleクラス（375行～426行、合計52行）
死亡時のパーティクルエフェクトを管理するクラス

### コンストラクター（382行～401行、合計20行）
パーティクルの初期設定とランダムな速度設定

### update関数（403行～423行、合計21行）
重力、移動、フェードアウト処理

## Floorクラス（428行～457行、合計30行）
床オブジェクトを管理するクラス

### コンストラクター（433行～447行、合計15行）
床の描画とプロパティ初期化

### getBounds関数（449行～456行、合計8行）
衝突判定用の境界情報を返す

## BodySegmentクラス（459行～521行、合計63行）
プレイヤーの体のセグメントを管理するクラス

### コンストラクター（467行～490行、合計24行）
スプライトの作成とテクスチャの設定

### update関数（492行～500行、合計9行）
位置更新処理

### updateSpritePosition関数（502行～512行、合計11行）
スプライトの描画位置と向きの更新

### その他のヘルパー関数（514行～520行、合計7行）
- setHeadDirection（514行～516行、合計3行）
- getPosition（518行～520行、合計3行）

## Headクラス（523行～888行、合計366行）
プレイヤーキャラクターの頭部を管理するメインクラス

### コンストラクター（537行～540行、合計4行）
初期化処理の呼び出し

### init関数（542行～572行、合計31行）
- スプライトの作成（543行～557行、合計15行）
- イベントリスナーの設定（560行～568行、合計9行）
- 体のセグメント初期化呼び出し（571行、合計1行）

### initBodySegments関数（574行～590行、合計17行）
体のセグメントの作成と初期配置

### update関数（592行～658行、合計67行）
#### 糸の引力計算（596行～620行、合計25行）
糸がブロックに刺さっている場合の物理計算

#### 物理演算（623行～631行、合計9行）
重力と速度減衰の適用

#### 衝突判定呼び出し（634行～640行、合計7行）
床とブロックの衝突判定

#### 画面端制限と更新処理（643行～657行、合計15行）
位置制限と各種更新処理の呼び出し

### checkRidingBlock関数（660行～686行、合計27行）
ブロックに乗っているかの判定と移動処理

### updateDirection関数（688行～698行、合計11行）
キャラクターの向きの更新

### updateBodySegments関数（700行～753行、合計54行）
体のセグメントの追従処理（長い処理のため内部構造あり）
- 方向ベクトルの計算（704行～726行、合計23行）
- 各セグメントの速度計算ループ（729行～752行、合計24行）

### checkFloorCollision関数（755行～774行、合計20行）
床との衝突判定と位置補正

### checkBlockCollision関数（776行～838行、合計63行）
ブロックとの衝突判定と押し出し処理（長い処理のため内部構造あり）
- 衝突判定（788行～793行、合計6行）
- 押し出し処理（795行～834行、合計40行）
  - 重複量の計算（795行～802行、合計8行）
  - X方向の押し出し（806行～818行、合計13行）
  - Y方向の押し出し（820行～833行、合計14行）

### その他のヘルパー関数（840行～887行、合計48行）
- updateSpritePosition（840行～843行、合計4行）
- getPosition（845行～847行、合計3行）
- onMouseDown（849行～880行、合計32行）
  - ゲームオーバーチェック（852行～854行、合計3行）
  - 座標変換処理（857行～866行、合計10行）
  - 糸の発射処理（869行～879行、合計11行）
- onMouseUp（882行～887行、合計6行）

## MainSceneクラス（890行～1094行、合計205行）
メインゲームシーンを管理するクラス

### コンストラクター（902行～923行、合計22行）
床の作成、主人公の初期化、スコア表示の設定

### update関数（925行～1021行、合計97行）
#### ブロックスポーン処理（928行～932行、合計5行）

#### 初回主人公追加処理（935行～940行、合計6行）

#### カメラ制御（943行～949行、合計7行）

#### ゲームオーバー判定と処理（952行～1011行、合計60行）
- 画面外判定（952行～961行、合計10行）
- 糸による復活チェック（964行～981行、合計18行）
- ゲームオーバー処理本体（984行～1011行、合計28行）
  - パーティクル削除（988行～994行、合計7行）
  - 暗転エフェクト（997行～1001行、合計5行）
  - シーン遷移（1004行～1011行、合計8行）

#### スコア更新とカメラ適用（1015行～1020行、合計6行）

### spawnBlock関数（1023行～1057行、合計35行）
ブロックの生成処理
- サイズとスポーン位置の計算（1025行～1032行、合計8行）
- 難易度に応じた速度設定（1035行～1045行、合計11行）
- ブロックの作成と追加（1047行～1056行、合計10行）

### その他のヘルパー関数（1059行～1093行、合計35行）
- getActors（1059行～1061行、合計3行）
- getCameraY（1063行～1065行、合計3行）
- spawnDeathParticles（1067行～1073行、合計7行）
- createFadeOverlay（1075行～1083行、合計9行）
- destroy（1085行～1093行、合計9行）